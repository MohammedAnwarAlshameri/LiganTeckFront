<!-- src/app/pages/apps/ticket-admin/ticket-admin.component.html -->

<!-- Start Breadcrumbs -->
<app-breadcrumbs title="Admin Tickets" [breadcrumbItems]="breadCrumbItems"></app-breadcrumbs>
<!-- End Breadcrumbs -->

<div class="row">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header">
        <h4 class="card-title mb-0">لوحة موظف العملاء - طلبات الدعم</h4>
      </div>

      <div class="card-body">
        <!-- فلاتر البحث -->
        <div class="filters-section mb-3">
          <div class="row g-3">
            <div class="col-md-3">
              <input
                type="text"
                class="form-control"
                placeholder="ابحث برقم/عنوان/عميل..."
                [(ngModel)]="q"
                (keyup.enter)="doSearch()">
            </div>
            <div class="col-md-2">
              <select class="form-select" [(ngModel)]="tenantFilter">
                <option *ngFor="let tenant of tenants" [value]="tenant.value">{{ tenant.label }}</option>
              </select>
            </div>
            <div class="col-md-2">
              <select class="form-select" [(ngModel)]="statusFilter">
                <option *ngFor="let status of statuses" [value]="status.value">{{ status.label }}</option>
              </select>
            </div>
            <div class="col-md-2">
              <select class="form-select" [(ngModel)]="priorityFilter">
                <option *ngFor="let priority of priorities" [value]="priority.value">{{ priority.label }}</option>
              </select>
            </div>
            <div class="col-md-2">
              <button class="btn btn-outline-secondary w-100" (click)="clearFilters()">
                <i class="ri-refresh-line"></i> مسح
              </button>
            </div>
            <div class="col-md-1">
              <button class="btn btn-primary w-100" (click)="doSearch()">
                <i class="ri-search-line"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- جدول التذاكر -->
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th style="width: 40px;">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="checkAll" 
                           [(ngModel)]="masterSelected" (change)="checkUncheckAll($event)">
                  </div>
                </th>
                <th style="width: 90px;">#</th>
                <th>الموضوع</th>
                <th style="width: 110px;">الأولوية</th>
                <th style="width: 130px;">الحالة</th>
                <th style="width: 150px;">العميل</th>
                <th style="width: 120px;">أُنشئت</th>
                <th style="width: 100px;">إجراءات</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="loading">
                <td colspan="8" class="text-center">جاري التحميل...</td>
              </tr>
              
              <tr *ngFor="let ticket of ticketsData; trackBy: trackById" 
                  (click)="viewTicket(ticket)" style="cursor: pointer;">
                <td>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" 
                           [value]="ticket.id" [(ngModel)]="ticket.state" 
                           (change)="syncChecked()" (click)="$event.stopPropagation()">
                  </div>
                </td>
                <td>{{ ticket.id }}</td>
                <td class="subject">
                  <span class="text-truncate d-block" [title]="ticket.subject">
                    {{ ticket.subject }}
                  </span>
                </td>
                <td>
                  <span class="badge" 
                        [ngClass]="{
                          'bg-success-subtle text-success': ticket.priority_color === 'success',
                          'bg-warning-subtle text-warning': ticket.priority_color === 'warning',
                          'bg-danger-subtle text-danger': ticket.priority_color === 'danger'
                        }">
                    <i class="ri-signal-tower-line me-1"></i>{{ ticket.priority }}
                  </span>
                </td>
                <td>
                  <span class="badge" 
                        [ngClass]="{
                          'bg-info-subtle text-info': ticket.status_color === 'info',
                          'bg-warning-subtle text-warning': ticket.status_color === 'warning',
                          'bg-purple-subtle text-purple': ticket.status_color === 'purple',
                          'bg-success-subtle text-success': ticket.status_color === 'success'
                        }">
                    <i class="ri-circle-fill me-1"></i>{{ ticket.status }}
                  </span>
                </td>
                <td>{{ ticket.tenant_name }}</td>
                <td>{{ ticket.created_date }}</td>
                <td>
                  <button class="btn btn-sm btn-outline-primary" 
                          (click)="viewTicket(ticket); $event.stopPropagation()">
                    <i class="ri-eye-line"></i>
                  </button>
                </td>
              </tr>

              <tr *ngIf="!loading && ticketsData.length === 0">
                <td colspan="8" class="text-center text-muted">
                  <i class="ri-inbox-line fs-1 d-block mb-2"></i>
                  لا توجد نتائج
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- أزرار العمليات الجماعية -->
        <div class="bulk-actions mt-3" *ngIf="checkedValGet.length > 0">
          <div class="d-flex gap-2">
            <button class="btn btn-outline-info" (click)="bulkSetStatus(1)">
              <i class="ri-play-circle-line"></i> فتح
            </button>
            <button class="btn btn-outline-warning" (click)="bulkSetStatus(2)">
              <i class="ri-time-line"></i> قيد المعالجة
            </button>
            <button class="btn btn-outline-purple" (click)="bulkSetStatus(3)">
              <i class="ri-user-line"></i> بانتظار العميل
            </button>
            <button class="btn btn-outline-success" (click)="bulkSetStatus(4)">
              <i class="ri-check-circle-line"></i> إغلاق
            </button>
          </div>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-end mt-3">
          <pagination
            [totalItems]="total"
            [itemsPerPage]="pageSize"
            [maxSize]="5"
            [(ngModel)]="page"
            (pageChanged)="tablepageChanged($event)">
          </pagination>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- تفاصيل التذكرة والمحادثة -->
<div class="modal fade" #detailModal tabindex="-1" role="dialog" aria-labelledby="detailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="detailModalLabel">
          <i class="ri-ticket-line me-2"></i>
          تفاصيل التذكرة
        </h4>
        <button type="button" class="btn-close" (click)="closeDetailModal()"></button>
      </div>
      <div class="modal-body" *ngIf="selectedTicket">
        <!-- معلومات التذكرة -->
        <div class="row mb-4">
          <div class="col-md-8">
            <h5>#{{ selectedTicket.ticket.id }} — {{ selectedTicket.ticket.subject }}</h5>
            <p class="text-muted mb-0">أُنشئت في: {{ selectedTicket.ticket.created_date }}</p>
          </div>
          <div class="col-md-4 text-end">
            <div class="d-flex gap-2 justify-content-end">
              <span class="badge" 
                    [ngClass]="{
                      'bg-success-subtle text-success': selectedTicket.ticket.priority_color === 'success',
                      'bg-warning-subtle text-warning': selectedTicket.ticket.priority_color === 'warning',
                      'bg-danger-subtle text-danger': selectedTicket.ticket.priority_color === 'danger'
                    }">
                {{ selectedTicket.ticket.priority }}
              </span>
              <span class="badge" 
                    [ngClass]="{
                      'bg-info-subtle text-info': selectedTicket.ticket.status_color === 'info',
                      'bg-warning-subtle text-warning': selectedTicket.ticket.status_color === 'warning',
                      'bg-purple-subtle text-purple': selectedTicket.ticket.status_color === 'purple',
                      'bg-success-subtle text-success': selectedTicket.ticket.status_color === 'success'
                    }">
                {{ selectedTicket.ticket.status }}
              </span>
            </div>
          </div>
        </div>

        <!-- أدوات التحكم -->
        <div class="row mb-4">
          <div class="col-md-6">
            <label class="form-label">تحديث الحالة</label>
            <select class="form-select" #statusSelect (change)="updateTicketStatus(+statusSelect.value)">
              <option value="1">مفتوحة</option>
              <option value="2">قيد المعالجة</option>
              <option value="3">بانتظار العميل</option>
              <option value="4">مغلقة</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">تحديث الأولوية</label>
            <select class="form-select" #prioritySelect (change)="updateTicketPriority(prioritySelect.value)">
              <option value="low">منخفضة</option>
              <option value="medium">متوسطة</option>
              <option value="high">عالية</option>
            </select>
          </div>
        </div>

        <!-- المحادثة -->
        <div class="chat-container mb-4" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; background-color: #f8f9fa;">
          <div *ngFor="let chat of ticketChats" class="mb-3">
            <div class="d-flex" [ngClass]="chat.isAdmin ? 'justify-content-end' : 'justify-content-start'">
              <div class="message-bubble" 
                   [ngClass]="chat.isAdmin ? 'admin-message' : 'user-message'"
                   style="max-width: 70%; padding: 10px 15px; border-radius: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <p class="mb-1">{{ chat.message }}</p>
                <small class="text-muted">{{ chat.timestamp }}</small>
              </div>
            </div>
          </div>
        </div>

        <!-- إضافة رد -->
        <div class="chat-input">
          <div class="input-group">
            <input type="text" class="form-control" 
                   placeholder="اكتب ردّك للعميل..." 
                   [(ngModel)]="replyMessage"
                   (keyup.enter)="addReply()">
            <button class="btn btn-primary" type="button" (click)="addReply()">
              <i class="ri-send-plane-line"></i> إرسال
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" (click)="closeDetailModal()">إغلاق</button>
      </div>
    </div>
  </div>
</div>
